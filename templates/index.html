<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>VIN ETERNITY | ENGINE</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/marked/9.1.2/marked.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Rajdhani:wght@400;600;700&family=Share+Tech+Mono&display=swap" rel="stylesheet">
    <style>
        /* CORE AESTHETICS */
        body { font-family: 'Rajdhani', sans-serif; background: #000; color: #fff; overflow: hidden; cursor: crosshair; }
        .mono { font-family: 'Share Tech Mono', monospace; }
        
        /* PARALLAX BG */
        #starfield { position: absolute; top: -50%; left: -50%; width: 200%; height: 200%; background-image: radial-gradient(white 1px, transparent 1px); background-size: 50px 50px; opacity: 0.1; z-index: 0; transition: transform 0.1s ease-out; }

        /* MESSAGE STYLES */
        .msg-user { background: rgba(0, 255, 255, 0.1); border: 1px solid #00ffff; color: #00ffff; border-radius: 12px 0 12px 12px; box-shadow: 0 0 10px rgba(0,255,255,0.1); }
        .msg-ai { background: rgba(0, 0, 0, 0.8); border-left: 3px solid #fff; padding-left: 15px; color: #ccc; font-family: 'Share Tech Mono', monospace; font-size: 14px; }
        
        /* REBEL MODE */
        .rebel .msg-ai { border-left-color: #ff0000; color: #ff9999; }
        .rebel-glow { box-shadow: 0 0 20px rgba(255, 0, 0, 0.3) !important; border-color: #ff0000 !important; }

        /* DECRYPT EFFECT CURSOR */
        .cursor { display: inline-block; width: 8px; height: 16px; background: #0ff; animation: blink 1s infinite; }
    </style>
</head>
<body class="h-screen flex flex-col relative">

    <div id="starfield"></div>

    <div class="h-16 border-b border-white/10 flex justify-between items-center px-6 bg-black/80 backdrop-blur-md z-50 relative">
        <div class="flex flex-col">
            <h1 class="text-2xl font-bold tracking-[4px]">VIN<span class="text-cyan-400">ETERNITY</span></h1>
            <span class="text-[9px] text-gray-500 mono tracking-widest">OP: {{ user }} // ID: {{ mission_id }}</span>
        </div>
        
        <div class="flex items-center gap-4">
            <button id="voiceBtn" onclick="toggleVoice()" class="text-[10px] border border-gray-600 px-3 py-1 rounded text-gray-400 hover:text-white transition">
                VOICE: OFF
            </button>
            
            <button id="rebelBtn" onclick="toggleRebel()" class="text-[10px] border border-cyan-600 px-3 py-1 rounded text-cyan-400 hover:bg-cyan-900/30 transition">
                MODE: CORE
            </button>

            <a href="/logout" class="text-xs text-red-500 hover:text-red-300">LOGOUT</a>
        </div>
    </div>

    <div id="chatFeed" class="flex-1 overflow-y-auto p-4 md:p-8 space-y-6 pb-32 z-10 scroll-smooth relative">
        <div id="intro" class="absolute inset-0 flex flex-col items-center justify-center pointer-events-none opacity-50">
            <div class="w-20 h-20 border border-cyan-500 rounded-full flex items-center justify-center animate-pulse mb-4">
                <div class="w-16 h-16 bg-cyan-500/20 rounded-full"></div>
            </div>
            <h2 class="text-xl mono text-cyan-500">SYSTEM INITIALIZED</h2>
            <p class="text-xs text-gray-500 mt-2">WAITING FOR OPERATOR INPUT...</p>
        </div>
    </div>

    <div class="bg-black/90 border-t border-white/10 p-4 w-full absolute bottom-0 z-50">
        <div class="max-w-4xl mx-auto flex flex-col gap-2">
            
            <select id="modelSelect" class="bg-black border border-white/10 text-[10px] text-gray-500 p-1 w-max outline-none focus:border-cyan-500">
                <option value="llama-3.3-70b-versatile">VIN TITAN (LOGIC CORE)</option>
                <option value="chatgpt-os">CHATGPT OS (PREMIUM)</option>
                <option value="vision">VIN OCULUS (VISUAL)</option>
                <option value="audio">VIN VOX (AUDITORY)</option>
            </select>

            <div id="inputBox" class="flex items-end gap-0 border border-white/20 bg-black transition-all">
                <button onclick="document.getElementById('fileInput').click()" class="p-3 text-gray-500 hover:text-white">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"></path></svg>
                </button>
                <input type="file" id="fileInput" class="hidden" onchange="handleFile(this)">
                
                <textarea id="userInput" rows="1" class="w-full bg-transparent text-white text-base p-3 focus:outline-none resize-none mono" placeholder="Enter Command Sequence..."></textarea>
                
                <button onclick="send()" class="p-3 text-cyan-500 font-bold hover:bg-cyan-900/20 tracking-widest text-xs">SEND</button>
            </div>
        </div>
    </div>

    <script>
        // --- CONFIG ---
        let rebel = false;
        let voice = false;
        let history = [];
        let currentFile = null;
        const synth = window.speechSynthesis;

        // --- MOUSE PARALLAX EFFECT ---
        document.addEventListener('mousemove', (e) => {
            const x = (window.innerWidth - e.pageX) / 50;
            const y = (window.innerHeight - e.pageY) / 50;
            document.getElementById('starfield').style.transform = `translate(${x}px, ${y}px)`;
        });

        // --- SOUND EFFECTS (Click) ---
        function playClick() {
            // Simple oscillator beep for "tech" feel
            const ctx = new (window.AudioContext || window.webkitAudioContext)();
            const osc = ctx.createOscillator();
            const gain = ctx.createGain();
            osc.type = 'sine';
            osc.frequency.value = 800;
            gain.gain.exponentialRampToValueAtTime(0.00001, ctx.currentTime + 0.04);
            osc.connect(gain);
            gain.connect(ctx.destination);
            osc.start();
            osc.stop(0.04);
        }

        // --- TOGGLES ---
        function toggleRebel() {
            playClick();
            rebel = !rebel;
            const btn = document.getElementById('rebelBtn');
            const box = document.getElementById('inputBox');
            document.body.classList.toggle('rebel', rebel);
            
            if(rebel) {
                btn.innerText = "MODE: REBEL";
                btn.classList.add('text-red-500', 'border-red-500');
                box.classList.add('rebel-glow');
            } else {
                btn.innerText = "MODE: CORE";
                btn.classList.remove('text-red-500', 'border-red-500');
                box.classList.remove('rebel-glow');
            }
        }

        function toggleVoice() {
            playClick();
            voice = !voice;
            const btn = document.getElementById('voiceBtn');
            btn.innerText = voice ? "VOICE: ON" : "VOICE: OFF";
            btn.className = voice ? "text-[10px] border border-green-500 px-3 py-1 rounded text-green-400" : "text-[10px] border border-gray-600 px-3 py-1 rounded text-gray-400";
        }

        function speak(text) {
            if(!voice) return;
            synth.cancel();
            const utter = new SpeechSynthesisUtterance(text);
            utter.pitch = rebel ? 0.8 : 1; // Lower pitch for Rebel
            utter.rate = 1.1;
            synth.speak(utter);
        }

        // --- DECRYPTION TEXT EFFECT ---
        function decryptText(element, text) {
            let iterations = 0;
            const letters = "ABCDEFGHIJKLMNOPQRSTUVWXYZ1234567890@#$%^&*";
            const interval = setInterval(() => {
                element.innerText = text.split("").map((letter, index) => {
                    if(index < iterations) return letter;
                    return letters[Math.floor(Math.random() * 26)];
                }).join("");
                
                if(iterations >= text.length) clearInterval(interval);
                iterations += 1 / 2; // Speed
            }, 30);
        }

        // --- CORE CHAT ---
        function handleFile(input) {
            if(input.files[0]) {
                playClick();
                currentFile = input.files[0];
                const box = document.getElementById('userInput');
                box.value = `[FILE ATTACHED: ${currentFile.name}]`;
                const sel = document.getElementById('modelSelect');
                if(currentFile.type.includes('image')) sel.value = 'vision';
                if(currentFile.type.includes('audio')) sel.value = 'audio';
            }
        }

        async function send() {
            playClick();
            const input = document.getElementById('userInput');
            let txt = input.value.trim();
            const model = document.getElementById('modelSelect').value;

            if(!txt && !currentFile) return;
            if(txt.startsWith("[FILE ATTACHED")) txt = ""; // Clear file placeholder text

            document.getElementById('intro').style.display = 'none';
            input.value = '';

            // User Msg
            appendMsg('user', txt || `[TRANSMITTING FILE: ${currentFile.name}]`);

            // Loading
            const loadId = 'load-'+Date.now();
            appendLoading(loadId);

            try {
                let resp;
                if(currentFile) {
                    const fd = new FormData();
                    fd.append('file', currentFile);
                    if(txt) fd.append('prompt', txt);
                    const ep = model === 'audio' ? '/api/audio' : '/api/vision';
                    const r = await fetch(ep, {method:'POST', body:fd});
                    const d = await r.json();
                    resp = d.response;
                    currentFile = null;
                } else {
                    const r = await fetch('/api/chat', {
                        method:'POST',
                        headers:{'Content-Type':'application/json'},
                        body:JSON.stringify({
                            message:txt, history:history, model:model, rebel: rebel
                        })
                    });
                    const d = await r.json();
                    resp = d.response;
                }

                document.getElementById(loadId).remove();
                
                // Add AI Msg with Effect
                const msgDiv = appendMsg('ai', ''); // Create empty bubble
                const contentDiv = msgDiv.querySelector('.content');
                
                // Markdown parse + Decrypt effect is tricky, so we just type raw text or simple parse
                // For "Matrix" feel, we decrypt short text, but for long text we just fade in.
                contentDiv.innerHTML = marked.parse(resp);
                speak(resp.replace(/[*#`]/g, '')); // Speak clean text

                history.push({"role": rebel ? "user" : "user", "content": txt});
                history.push({"role": "assistant", "content": resp});

            } catch(e) {
                document.getElementById(loadId).remove();
                appendMsg('ai', "SYSTEM CRITICAL FAILURE: " + e);
            }
        }

        function appendMsg(role, text) {
            const feed = document.getElementById('chatFeed');
            const div = document.createElement('div');
            div.className = `flex ${role==='user'?'justify-end':'justify-start'}`;
            
            div.innerHTML = `
                <div class="max-w-[85%] p-4 text-sm ${role==='user'?'msg-user':'msg-ai'} shadow-lg">
                    <div class="content">${role==='user' ? text : ''}</div>
                </div>
            `;
            feed.appendChild(div);
            feed.scrollTop = feed.scrollHeight;
            return div;
        }

        function appendLoading(id) {
            const feed = document.getElementById('chatFeed');
            const div = document.createElement('div');
            div.id = id;
            div.className = 'text-[10px] text-cyan-500 ml-4 animate-pulse mono';
            div.innerText = 'PROCESSING NEURAL PATHWAYS...';
            feed.appendChild(div);
            feed.scrollTop = feed.scrollHeight;
        }

        // Enter Key Send
        document.getElementById('userInput').addEventListener('keydown', (e) => {
            if(e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); send(); }
        });
    </script>
</body>
</html>