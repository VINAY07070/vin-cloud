<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VinGPT Pro</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github-dark.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>✨</text></svg>">

    <style>
        /* Modern Scrollbar */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-thumb { background: #e5e7eb; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #d1d5db; }
        
        /* Markdown Styles */
        .prose pre { background: #1e1e1e !important; padding: 1rem; border-radius: 0.5rem; overflow-x: auto; margin: 1rem 0; }
        .prose code { font-family: 'Menlo', 'Monaco', 'Courier New', monospace; font-size: 0.9em; }
        .prose p { margin-bottom: 0.8rem; line-height: 1.6; }
        .prose ul { list-style-type: disc; padding-left: 1.5rem; margin-bottom: 1rem; }
        .prose ol { list-style-type: decimal; padding-left: 1.5rem; margin-bottom: 1rem; }
        .prose strong { font-weight: 600; color: #111827; }
        
        /* Typing Cursor */
        .typing::after { content: '▋'; animation: blink 1s infinite; color: #000; }
        @keyframes blink { 0%, 100% { opacity: 1; } 50% { opacity: 0; } }
        
        /* Loading Skeleton */
        .skeleton { background: linear-gradient(90deg, #f3f4f6 25%, #e5e7eb 50%, #f3f4f6 75%); background-size: 200% 100%; animation: shimmer 1.5s infinite; border-radius: 4px; height: 1em; width: 100%; display: inline-block; }
        @keyframes shimmer { 0% { background-position: 200% 0; } 100% { background-position: -200% 0; } }
    </style>
</head>
<body class="bg-white h-screen flex text-gray-900 font-sans antialiased overflow-hidden">

    <div id="sidebar" class="w-64 bg-gray-50 border-r border-gray-200 flex flex-col hidden md:flex transition-all z-20">
        <div class="p-4 flex items-center gap-2 border-b border-gray-200">
            <div class="w-8 h-8 bg-black text-white rounded-lg flex items-center justify-center font-bold">V</div>
            <span class="font-semibold text-gray-900 tracking-tight">VinGPT Pro</span>
        </div>

        <div class="flex-1 overflow-y-auto p-4 space-y-6">
            
            <div>
                <label class="text-xs font-semibold text-gray-500 uppercase tracking-wider">Model</label>
                <select id="modelSelect" class="w-full mt-2 p-2 text-sm bg-white border border-gray-200 rounded-md focus:ring-1 focus:ring-black outline-none cursor-pointer">
                    <option value="llama-3.3-70b-versatile">Llama 3.3 70B (Smartest)</option>
                    <option value="llama-3.1-70b-versatile">Llama 3.1 70B (Stable)</option>
                    <option value="mixtral-8x7b-32768">Mixtral 8x7B (Balanced)</option>
                    <option value="gemma2-9b-it">Gemma 2 9B (Creative)</option>
                    <option value="llama-3.1-8b-instant">Llama 3.1 8B (Fast)</option>
                </select>
            </div>

            <div>
                <label class="text-xs font-semibold text-gray-500 uppercase tracking-wider">System Config</label>
                <div class="mt-2 space-y-3">
                    <input type="text" id="sysPrompt" value="You are a helpful AI." class="w-full p-2 text-sm bg-white border border-gray-200 rounded-md placeholder-gray-400 focus:ring-1 focus:ring-black outline-none" placeholder="System Prompt (e.g. Be rude)">
                    
                    <div class="flex items-center justify-between">
                        <span class="text-xs text-gray-600">Creativity</span>
                        <input type="range" id="tempRange" min="0" max="1" step="0.1" value="0.7" class="w-20 accent-black">
                    </div>
                </div>
            </div>

            <div class="pt-4 border-t border-gray-200 space-y-2">
                <button onclick="exportChat()" class="w-full text-left text-sm text-gray-600 hover:text-black hover:bg-gray-100 p-2 rounded-md flex items-center gap-2">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg>
                    Export Chat
                </button>
                <button onclick="clearChat()" class="w-full text-left text-sm text-red-500 hover:bg-red-50 p-2 rounded-md flex items-center gap-2">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                    Clear Context
                </button>
            </div>
        </div>

        <div class="p-4 border-t border-gray-200">
            <a href="/logout" class="flex items-center gap-2 text-sm text-gray-600 hover:text-black">
                <div class="w-8 h-8 bg-gray-200 rounded-full flex items-center justify-center font-bold text-xs">{{ user[0]|upper }}</div>
                <div class="flex flex-col">
                    <span class="font-medium">{{ user }}</span>
                    <span class="text-xs text-gray-400">Log out</span>
                </div>
            </a>
        </div>
    </div>

    <div class="flex-1 flex flex-col relative bg-white">
        
        <div class="md:hidden p-3 border-b border-gray-200 flex justify-between items-center bg-white/80 backdrop-blur z-30 sticky top-0">
            <span class="font-bold">VinGPT</span>
            <button onclick="document.getElementById('sidebar').classList.toggle('hidden'); document.getElementById('sidebar').classList.toggle('absolute'); document.getElementById('sidebar').classList.toggle('h-full');" class="text-gray-600">☰</button>
        </div>

        <div id="chatContainer" class="flex-1 overflow-y-auto p-4 md:p-8 space-y-6 pb-32 max-w-3xl mx-auto w-full">
            <div id="emptyState" class="h-full flex flex-col items-center justify-center text-center opacity-50">
                <div class="w-16 h-16 bg-gray-100 rounded-2xl flex items-center justify-center mb-4">
                    <span class="text-3xl">✨</span>
                </div>
                <h2 class="text-xl font-semibold text-gray-900">How can I help you today?</h2>
            </div>
        </div>

        <div class="absolute bottom-0 w-full bg-gradient-to-t from-white via-white to-transparent pb-6 pt-10 px-4">
            <div class="max-w-3xl mx-auto relative">
                <div class="bg-white border border-gray-200 shadow-xl rounded-2xl flex items-end p-2 focus-within:ring-2 focus-within:ring-black/10 transition-shadow">
                    
                    <textarea id="userInput" rows="1" class="w-full bg-transparent border-none focus:ring-0 resize-none p-3 max-h-48 text-gray-900 placeholder-gray-400" placeholder="Message VinGPT..."></textarea>
                    
                    <button onclick="sendMessage()" id="sendBtn" class="p-2 bg-black text-white rounded-xl hover:bg-gray-800 disabled:opacity-50 disabled:cursor-not-allowed mb-1 mr-1 transition-colors">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 12h14M12 5l7 7-7 7"></path></svg>
                    </button>
                </div>
                <p class="text-center text-xs text-gray-400 mt-2">VinGPT can make mistakes. Verify important info.</p>
            </div>
        </div>
    </div>

    <div id="toast" class="fixed top-5 right-5 bg-black text-white px-4 py-2 rounded-lg shadow-lg transform translate-y-[-150%] transition-transform duration-300 z-50 text-sm">
        Notification
    </div>

    <script>
        let history = [];
        const chatContainer = document.getElementById('chatContainer');
        const userInput = document.getElementById('userInput');

        // --- CORE FUNCTIONS ---

        async function sendMessage() {
            const text = userInput.value.trim();
            if (!text) return;

            // UI Updates
            document.getElementById('emptyState').style.display = 'none';
            userInput.value = '';
            userInput.style.height = 'auto';
            
            // Add User Message
            addMessage('user', text);
            history.push({ role: "user", content: text });

            // Add Loading Skeleton
            const loadingId = 'load-' + Date.now();
            addLoading(loadingId);

            try {
                const response = await fetch('/api/generate', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        history: history,
                        model: document.getElementById('modelSelect').value,
                        system: document.getElementById('sysPrompt').value,
                        temperature: document.getElementById('tempRange').value
                    })
                });

                if (!response.ok) throw new Error("Connection failed");
                const data = await response.json();
                
                // Remove Loading & Stream Response
                document.getElementById(loadingId).remove();
                addMessage('assistant', data.response, true); // true = animate
                history.push({ role: "assistant", content: data.response });
                saveLocal();

            } catch (e) {
                document.getElementById(loadingId).remove();
                showToast("Error: " + e.message);
            }
        }

        // --- UI BUILDERS ---

        function addMessage(role, text, animate = false) {
            const div = document.createElement('div');
            const isUser = role === 'user';
            
            div.className = `flex gap-4 ${isUser ? 'flex-row-reverse' : ''} mb-6`;
            
            const avatar = isUser 
                ? `<div class="w-8 h-8 bg-gray-200 rounded-full flex-shrink-0"></div>`
                : `<div class="w-8 h-8 bg-black text-white rounded-full flex items-center justify-center flex-shrink-0 font-bold">V</div>`;
            
            const contentClass = isUser 
                ? "bg-gray-100 px-4 py-2 rounded-2xl rounded-tr-none text-gray-900" 
                : "prose max-w-none text-gray-800 w-full";

            div.innerHTML = `
                ${avatar}
                <div class="relative group max-w-[85%]">
                    <div class="${contentClass} ${animate ? 'typing' : ''}" id="msg-${Date.now()}">
                        ${isUser ? text : (animate ? '' : marked.parse(text))}
                    </div>
                    ${!isUser ? `
                    <div class="flex gap-2 mt-2 opacity-0 group-hover:opacity-100 transition-opacity">
                        <button onclick="copyText(this)" class="text-xs text-gray-400 hover:text-black">Copy</button>
                        <button onclick="speakText(this)" class="text-xs text-gray-400 hover:text-black">Read</button>
                    </div>` : ''}
                </div>
            `;
            
            chatContainer.appendChild(div);
            scrollToBottom();

            if (animate && !isUser) {
                typeText(div.querySelector('.typing'), text);
            } else if (!isUser) {
                 hljs.highlightAll();
            }
        }

        function addLoading(id) {
            const div = document.createElement('div');
            div.id = id;
            div.className = "flex gap-4 mb-6";
            div.innerHTML = `
                <div class="w-8 h-8 bg-black text-white rounded-full flex items-center justify-center flex-shrink-0 font-bold">V</div>
                <div class="space-y-2 w-full max-w-md pt-2">
                    <div class="skeleton w-3/4"></div>
                    <div class="skeleton w-1/2"></div>
                </div>
            `;
            chatContainer.appendChild(div);
            scrollToBottom();
        }

        // --- UTILITIES ---

        function typeText(element, text) {
            let i = 0;
            element.innerHTML = ""; // Clear for typing
            const speed = 10; // ms per char
            
            function type() {
                if (i < text.length) {
                    element.innerHTML = marked.parse(text.substring(0, i + 1));
                    i++;
                    scrollToBottom();
                    setTimeout(type, speed);
                } else {
                    element.classList.remove('typing');
                    hljs.highlightAll();
                    // Clean up markdown rendering artifacts if necessary
                    element.innerHTML = marked.parse(text); 
                    hljs.highlightAll();
                }
            }
            type();
        }

        function copyText(btn) {
            const text = btn.parentElement.parentElement.querySelector('.prose').innerText;
            navigator.clipboard.writeText(text);
            showToast("Copied to clipboard");
        }

        function speakText(btn) {
            const text = btn.parentElement.parentElement.querySelector('.prose').innerText;
            const utter = new SpeechSynthesisUtterance(text);
            
            // Try to find a good voice
            const voices = window.speechSynthesis.getVoices();
            const preferred = voices.find(v => v.name.includes("Google US English") || v.name.includes("Samantha"));
            if (preferred) utter.voice = preferred;
            
            window.speechSynthesis.cancel();
            window.speechSynthesis.speak(utter);
        }

        function scrollToBottom() {
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        function showToast(msg) {
            const t = document.getElementById('toast');
            t.innerText = msg;
            t.style.transform = "translateY(0)";
            setTimeout(() => t.style.transform = "translateY(-150%)", 2000);
        }

        function exportChat() {
            const text = history.map(m => `${m.role.toUpperCase()}: ${m.content}`).join('\n\n');
            const blob = new Blob([text], { type: 'text/plain' });
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = 'vin-gpt-chat.txt';
            a.click();
        }

        function clearChat() {
            if(confirm("Clear conversation context?")) {
                history = [];
                chatContainer.innerHTML = '';
                document.getElementById('emptyState').style.display = 'flex';
                localStorage.removeItem('vin_gpt_history');
            }
        }

        function saveLocal() {
            localStorage.setItem('vin_gpt_history', JSON.stringify(history));
        }

        // Auto-Resize Textarea
        userInput.addEventListener('input', function() {
            this.style.height = 'auto';
            this.style.height = (this.scrollHeight) + 'px';
        });

        // Enter to send
        userInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });

        // Load History
        window.onload = () => {
            const saved = localStorage.getItem('vin_gpt_history');
            if (saved) {
                history = JSON.parse(saved);
                if (history.length > 0) document.getElementById('emptyState').style.display = 'none';
                history.forEach(m => addMessage(m.role, m.content, false));
            }
        };
    </script>
</body>
</html>
