<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>VinOS</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        body { background: #111; color: #eee; font-family: sans-serif; overscroll-behavior: none; }
        .msg-user { background: #7c3aed; color: white; border-radius: 15px 15px 0 15px; }
        .msg-ai { background: #222; color: #ddd; border-radius: 15px 15px 15px 0; }
        
        /* Audio Pulse */
        .pulse { animation: pulse 1.5s infinite; box-shadow: 0 0 0 0 rgba(124, 58, 237, 0.7); }
        @keyframes pulse { 0% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(124, 58, 237, 0.7); } 70% { transform: scale(1); box-shadow: 0 0 0 10px rgba(124, 58, 237, 0); } 100% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(124, 58, 237, 0); } }

        /* Mobile Scrollbar Hide */
        ::-webkit-scrollbar { display: none; }
    </style>
</head>
<body class="h-screen flex flex-col">

    <div class="h-14 bg-black border-b border-white/10 flex items-center justify-between px-4 sticky top-0 z-50">
        <div class="font-bold tracking-wider">VIN<span class="text-purple-500">OS</span></div>
        <div class="flex gap-4">
            <button onclick="clearHistory()" class="text-xs text-gray-400 uppercase hover:text-white">Clear RAM</button>
            <a href="/logout" class="text-xs text-red-500 uppercase">Exit</a>
        </div>
    </div>

    <div id="chatFeed" class="flex-1 overflow-y-auto p-4 space-y-4 pb-32">
        <div id="welcome" class="h-full flex flex-col items-center justify-center opacity-20">
            <h1 class="text-4xl font-bold">V.K.</h1>
            <p class="text-xs mt-2 uppercase tracking-widest">System Unchained</p>
        </div>
    </div>

    <div class="fixed bottom-0 w-full bg-[#111] border-t border-white/10 p-4 pb-6">
        <div class="flex items-end gap-2 max-w-3xl mx-auto">
            
            <button id="micBtn" onmousedown="startRecord()" onmouseup="stopRecord()" ontouchstart="startRecord()" ontouchend="stopRecord()" class="p-3 bg-gray-800 rounded-full text-white active:bg-purple-600 transition touch-manipulation">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z"></path></svg>
            </button>

            <textarea id="inp" rows="1" class="flex-1 bg-black border border-white/20 rounded-2xl p-3 text-sm focus:outline-none focus:border-purple-500 resize-none max-h-32" placeholder="Command..."></textarea>
            
            <button onclick="sendText()" class="p-3 bg-purple-600 rounded-full text-white shadow-lg shadow-purple-900/50">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 12h14M12 5l7 7-7 7"></path></svg>
            </button>
        </div>
    </div>

    <script>
        let history = [];
        let mediaRecorder;
        let audioChunks = [];

        // LOAD HISTORY
        const saved = localStorage.getItem('vin_prestige_hist');
        if(saved) {
            history = JSON.parse(saved);
            if(history.length) document.getElementById('welcome').style.display='none';
            history.forEach(m => appendMsg(m.role, m.content));
        }

        // --- TEXT CHAT ---
        async function sendText() {
            const inp = document.getElementById('inp');
            const txt = inp.value.trim();
            if(!txt) return;

            document.getElementById('welcome').style.display='none';
            inp.value = '';
            
            appendMsg('user', txt);
            saveHist('user', txt);

            // API Call
            try {
                const res = await fetch('/api/chat', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ message: txt, history: history })
                });
                const data = await res.json();
                appendMsg('ai', data.response);
                saveHist('assistant', data.response);
            } catch(e) {
                appendMsg('ai', "SYSTEM ERROR.");
            }
        }

        // --- AUDIO CHAT ---
        async function startRecord() {
            document.getElementById('micBtn').classList.add('pulse', 'bg-purple-600');
            const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
            mediaRecorder = new MediaRecorder(stream);
            audioChunks = [];
            mediaRecorder.ondataavailable = e => audioChunks.push(e.data);
            mediaRecorder.start();
        }

        async function stopRecord() {
            document.getElementById('micBtn').classList.remove('pulse', 'bg-purple-600');
            if(!mediaRecorder) return;
            mediaRecorder.stop();
            mediaRecorder.onstop = async () => {
                const blob = new Blob(audioChunks, { type: 'audio/webm' });
                const formData = new FormData();
                formData.append('file', blob, 'voice.webm');

                appendMsg('user', "ðŸŽ¤ Audio Transmission...");
                
                try {
                    const res = await fetch('/api/audio', { method: 'POST', body: formData });
                    const data = await res.json();
                    
                    // Replace "Audio Transmission" with actual text
                    document.querySelector('.msg-user:last-child').innerHTML = data.user_text;
                    saveHist('user', data.user_text);
                    
                    appendMsg('ai', data.ai_text);
                    saveHist('assistant', data.ai_text);
                } catch(e) {
                    appendMsg('ai', "AUDIO DECRYPT FAILED.");
                }
            };
        }

        // --- UTILS ---
        function appendMsg(role, text) {
            const div = document.createElement('div');
            div.className = `flex ${role==='user'?'justify-end':'justify-start'} animate-fade`;
            div.innerHTML = `<div class="max-w-[85%] p-3 text-sm ${role==='user'?'msg-user':'msg-ai'}">${marked.parse(text)}</div>`;
            document.getElementById('chatFeed').appendChild(div);
            window.scrollTo(0, document.body.scrollHeight);
        }

        function saveHist(role, content) {
            history.push({role, content});
            localStorage.setItem('vin_prestige_hist', JSON.stringify(history));
        }

        function clearHistory() {
            if(confirm("Wipe Memory?")) {
                localStorage.removeItem('vin_prestige_hist');
                location.reload();
            }
        }
    </script>
</body>
</html>