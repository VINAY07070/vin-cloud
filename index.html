<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>VinOS</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600&display=swap" rel="stylesheet">
    <style>
        body { background: #050505; color: #eee; font-family: 'Inter', sans-serif; overscroll-behavior: none; }
        
        /* Chat Bubbles */
        .msg-user { background: #6366f1; color: white; border-radius: 18px 18px 4px 18px; box-shadow: 0 4px 15px rgba(99, 102, 241, 0.3); }
        .msg-ai { background: #1a1a1a; color: #e5e5e5; border-radius: 18px 18px 18px 4px; border: 1px solid #333; }
        
        /* Animation */
        .slide-up { animation: slideUp 0.3s ease-out; }
        @keyframes slideUp { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* Scrollbar Hide */
        ::-webkit-scrollbar { display: none; }
    </style>
</head>
<body class="h-screen flex flex-col">

    <div class="h-16 bg-[#0a0a0a]/90 backdrop-blur border-b border-white/5 flex items-center justify-between px-5 sticky top-0 z-50">
        <div>
            <div class="font-bold tracking-wider text-white">VIN<span class="text-indigo-500">OS</span></div>
            <div class="text-[10px] text-gray-500">Welcome, <span class="text-indigo-400 font-bold">{{ user }}</span></div>
        </div>
        <div class="flex gap-4">
            <button onclick="clearHistory()" class="text-[10px] font-bold text-gray-400 uppercase hover:text-white transition tracking-widest border border-white/10 px-3 py-1.5 rounded-full hover:bg-white/5">
                Clear History
            </button>
            <a href="/logout" class="text-[10px] font-bold text-red-500 uppercase hover:text-red-400 transition tracking-widest pt-2">
                Exit
            </a>
        </div>
    </div>

    <div id="chatFeed" class="flex-1 overflow-y-auto p-4 space-y-6 pb-32 scroll-smooth">
        <div id="welcome" class="h-full flex flex-col items-center justify-center opacity-30 select-none">
            <div class="w-16 h-16 rounded-full bg-indigo-500/20 flex items-center justify-center text-2xl mb-4">ðŸ’ </div>
            <h1 class="text-2xl font-bold tracking-tight">System Online</h1>
            <p class="text-xs mt-2 text-gray-500 uppercase tracking-widest">Architected by V.K.</p>
        </div>
    </div>

    <div class="fixed bottom-0 w-full bg-gradient-to-t from-black via-black to-transparent p-4 pb-8">
        <div class="flex items-end gap-2 max-w-3xl mx-auto bg-[#111] border border-white/10 p-2 rounded-2xl shadow-2xl">
            <textarea id="inp" rows="1" class="flex-1 bg-transparent text-white placeholder-gray-600 text-sm p-3 focus:outline-none resize-none max-h-32" placeholder="Message VinOS..."></textarea>
            <button onclick="send()" class="p-3 bg-indigo-600 hover:bg-indigo-500 rounded-xl text-white transition shadow-lg shadow-indigo-900/20">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 12h14M12 5l7 7-7 7"></path></svg>
            </button>
        </div>
    </div>

    <script>
        let history = [];
        
        // --- LOAD LOCAL HISTORY ---
        window.onload = () => {
            const saved = localStorage.getItem('vin_platinum_hist');
            if(saved) {
                history = JSON.parse(saved);
                if(history.length) document.getElementById('welcome').style.display='none';
                history.forEach(m => appendMsg(m.role, m.content, false));
            }
        };

        // --- SEND MESSAGE ---
        async function send() {
            const inp = document.getElementById('inp');
            const txt = inp.value.trim();
            if(!txt) return;

            document.getElementById('welcome').style.display='none';
            inp.value = '';
            inp.style.height = 'auto'; // Reset height
            
            appendMsg('user', txt);
            saveHist('user', txt);

            try {
                const res = await fetch('/api/chat', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ message: txt, history: history })
                });
                const data = await res.json();
                appendMsg('ai', data.response);
                saveHist('assistant', data.response);
            } catch(e) {
                appendMsg('ai', "SYSTEM ERROR: CONNECTION LOST.");
            }
        }

        // --- RENDER MESSAGE ---
        function appendMsg(role, text, animate=true) {
            const div = document.createElement('div');
            const isUser = role==='user';
            div.className = `flex ${isUser?'justify-end':'justify-start'} ${animate?'slide-up':''} mb-2`;
            
            div.innerHTML = `
                <div class="flex flex-col ${isUser?'items-end':'items-start'} max-w-[85%]">
                    <div class="p-4 text-sm leading-relaxed ${isUser?'msg-user':'msg-ai'}">
                        ${marked.parse(text)}
                    </div>
                    ${!isUser ? `
                    <button onclick="speak(this)" class="mt-2 flex items-center gap-1 text-[10px] text-gray-500 hover:text-indigo-400 transition uppercase tracking-wider font-bold">
                        <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.536 8.464a5 5 0 010 7.072m2.828-9.9a9 9 0 010 12.728M5.586 15H4a1 1 0 01-1-1v-4a1 1 0 011-1h1.586l4.707-4.707C10.923 3.663 12 4.109 12 5v14c0 .891-1.077 1.337-1.707.707L5.586 15z"></path></svg>
                        Play Audio
                    </button>
                    <div class="hidden text-xs text-gray-300 mt-1 speak-text">${text}</div>
                    ` : ''}
                </div>
            `;
            document.getElementById('chatFeed').appendChild(div);
            window.scrollTo(0, document.body.scrollHeight);
        }

        // --- REAL HUMAN VOICE (TTS) ---
        function speak(btn) {
            window.speechSynthesis.cancel();
            const text = btn.nextElementSibling.innerText;
            const utter = new SpeechSynthesisUtterance(text);
            const voices = window.speechSynthesis.getVoices();
            
            // Try to find a high-quality English voice
            const bestVoice = voices.find(v => 
                v.name.includes("Google US English") || 
                v.name.includes("Samantha") || 
                v.name.includes("Microsoft Zira")
            );
            
            if(bestVoice) utter.voice = bestVoice;
            utter.pitch = 1.0;
            utter.rate = 1.05; // Slightly faster for natural flow
            
            window.speechSynthesis.speak(utter);
            
            // UI Feedback
            const originalColor = btn.style.color;
            btn.style.color = "#818cf8"; // Indigo
            utter.onend = () => btn.style.color = originalColor;
        }

        // --- HISTORY MANAGE ---
        function saveHist(role, content) {
            history.push({role, content});
            localStorage.setItem('vin_platinum_hist', JSON.stringify(history));
        }

        function clearHistory() {
            // Clears LOCAL PHONE history only. Server logs remain.
            if(confirm("Clear conversation from this device?")) {
                localStorage.removeItem('vin_platinum_hist');
                location.reload();
            }
        }

        // --- UTILS ---
        const tx = document.getElementById('inp');
        tx.addEventListener('input', function() {
            this.style.height = 'auto';
            this.style.height = (this.scrollHeight) + 'px';
        });
        tx.addEventListener('keydown', (e) => {
            if(e.key==='Enter' && !e.shiftKey) { e.preventDefault(); send(); }
        });
    </script>
</body>
</html>
